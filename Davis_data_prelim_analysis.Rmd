---
title: 'Water quality trends'
author: "Kelly Loria"
date: "`r Sys.Date()`"
output:
   html_document:
    theme: united
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
body, td {font-size: 12px;}
code.r{font-size: 8px;}
pre {font-size: 10px}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = F, message = F)
#knitr::opts_knit$set(root.dir = 'C/Users/kloria/Documents/Davis_data_exploration/')
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

```

```{r, echo = F, message = F}
### Packages
#setwd("C/Users/kloria/Documents/Davis_data_exploration/")

library(tidyverse)
library(lubridate)
library(dataRetrieval)
library(viridis)
library(cowplot)
library(zoo)
library(readxl)
library(ggpubr)
library(knitr)
library(kableExtra)
library(plotly)
library(readxl)
library(ggpmisc)

site_colors <- c(
  "Ophir" = "#7d5ba6",
  "Winters" = "#4287f5",
  "Winters upstream" = "#7fc5f0",
  "Davis" = "#d9cb7c",
  "Browns" = "#c94d00", 
  "Browns sub"  = "#bd772d"
)


```


```{r, eval=TRUE, echo = F, error=FALSE, warning=FALSE, message=FALSE}
##### Function for water year:
# fxn for water year
water_year <- function(data) {
  data %>%
    mutate(date = ymd(date)) %>%
    mutate(WaterYear = if_else(month(date) >= 10, year(date) + 1, year(date)))
}
```



```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
# Chem data
davis_data <- read_excel("C:/Users/kloria/Documents/Davis_data_exploration/davis_data_pre_analysis.xlsx")
#View(davis_data)
str(davis_data)

davis_data$datetime_T <-(as.POSIXct(round_date(
  as.POSIXct(davis_data$datetime, format="%Y-%m-%dT%H:%M:%SOZ"), unit="5 minutes")))

davis_data <- davis_data %>%
  mutate(date= as.Date(datetime_T))%>%
  mutate(year = year(date))%>%
  mutate(jday = yday(date))%>%
  mutate(mon = month(date)) %>%
  # create dummy column for Creek to line up hydroclimate data
  mutate(creek = case_when(
    site== "Davis" ~ "davis", 
    site == "Ophir" ~ "ophir",
    site == "Winters" ~ "winters",
    site == "Winters upstream" ~ "winters",
    site == "Browns" ~ "ophir", 
    site == "Browns sub" ~ "ophir"))

```

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
# UV-vis
davis_UV <- read_csv("davis_data_pre_analysis_UV.csv") %>%
  mutate(date = as.Date((date), format("%m/%d/%Y")))

# UV-vis
davis_BC <- read_csv("Davis_BC_dat.csv") %>%
  mutate(dateTime= as.POSIXct(datetime, format="%m/%d/%Y %H:%M"),
         date = as.Date((dateTime), format("%m/%d/%Y"))) %>%
  mutate(
    BC = if_else(BC =="BDL",
                 BC_run_DL,
                 as.numeric(BC)))%>%
  mutate(
    BC_DL_lab = case_when(
    BC < BC_run_DL ~"yes",
    TRUE~"no"
  ))


```

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
# hydroclimate
davis_hclim <- readRDS("~/Davis_data_exploration/Davis_fire_flow_PPT.rds") %>%
# create column for day prior's PPT
  mutate(lag_PPT = lag(ppt..mm.)) %>%
  mutate(date=as.Date(Date)) 
  
```

```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
# hydroclimate
davis_dat <- davis_data %>%
  left_join(davis_UV, by=c("site", "date")) %>%
  left_join(davis_hclim, by=c("creek"="Name", "date")) #%>%
  #left_join(davis_BC, by=c("site", "date"))
```

Concentration–discharge response of DOC in relation to precipitation
events

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}

ref_date <- as.Date("2024-09-25")

df <- davis_dat %>%
  select(site, datetime.x, ppt..mm., lag_PPT, dischargeCMS, DOC.x, TOC.x, TDN.x,  
         SUVA_254, Sr.y, cdom, e2_e3, burn_area) %>%
  mutate(datetime = as.POSIXct(datetime.x),
         TDN = as.numeric(TDN.x),
         jday = as.numeric(format(datetime, "%j")),
         PPT_sum = ppt..mm. + lag_PPT,
                  days_since_burn = as.integer(difftime(datetime, ref_date, units = "days")))

```

### Site DOM characteristics

```{r, warning=F, size = 'small', echo=FALSE, fig.width=8, fig.height=3}

p1 <- df %>%
  ggplot(aes(x = burn_area,
             y = SUVA_254)) +
  geom_boxplot(aes(fill=site), alpha = 0.75) +
  geom_point(
    alpha = 0.8, size = 2, 
    aes(color = days_since_burn),
    position = position_jitter(width = 1),  
    shape = 19
  ) +
  scale_fill_manual(values = site_colors) +
  scale_color_viridis_c(option = "plasma") +
  labs(y = "SUVA 254", x = "Burn area", color = "days since burn") +
  guides(shape = "none") +
  theme_minimal()

p1a1 <- davis_BC %>%
  ggplot(aes(x = burn_area,
             y = BC)) +
  geom_boxplot(aes(fill=site), alpha = 0.75,
               width = 25) +
  geom_point(
    alpha = 0.5, size = 1, 
    #aes(color = days_since_burn),
    position = position_jitter(width = 1)) +
  ylim(0,4.8) +
  scale_fill_manual(values = site_colors) +
  #scale_color_viridis_c(option = "plasma") +
  labs(y = "BC", x = "Burn area", color = "days since burn") +
  guides(shape = "none") +
  theme_minimal()

p1a <- df %>%
  ggplot(aes(x = burn_area,
             y = DOC.x)) +
  geom_boxplot(aes(fill=site), alpha = 0.75,
               width = 25) +
  geom_point(
    alpha = 0.5, size = 1, 
    #aes(color = days_since_burn),
    position = position_jitter(width = 1),  
    shape = 19
  ) +
  ylim(0,4.8) +
  scale_fill_manual(values = site_colors) +
  #scale_color_viridis_c(option = "plasma") +
  labs(y = "DOC", x = "Burn area", color = "days since burn") +
  guides(shape = "none") +
  theme_minimal()


p1b <- df %>%
  ggplot(aes(x = burn_area,
             y = TDN)) +
  geom_boxplot(aes(fill=site), alpha = 0.75,
               width = 25) +
  geom_point(
    alpha = 0.5, size = 1, 
    #aes(color = days_since_burn),
    position = position_jitter(width = 1),  
    shape = 19
  ) +
    ylim(0,0.28) +
  scale_fill_manual(values = site_colors) +
  #scale_color_viridis_c(option = "plasma") +
  labs(y = "TDN", x = "Burn area", color = "days since burn") +
  guides(shape = "none") +
  theme_minimal()


p2 <- df %>%
  ggplot(aes(x = burn_area,
             y = Sr.y,)) +
  geom_boxplot(aes(fill=site), alpha = 0.75,
               width = 25)+
  geom_point(alpha = 0.5, size = 1,
                 position = position_jitter(width = 1),  
             shape=19) +
    scale_fill_manual(values = site_colors) +
  #  scale_color_viridis_c(option = "plasma") +
  labs(y = "Slope 275:295",x="Burn area", color = "days since burn") +
  guides(shape = "none") +       # hides shape legend
  theme_minimal()

p3 <- df %>%
  ggplot(aes(x = burn_area,
             y = cdom)) +
    geom_boxplot(aes(fill=site), alpha = 0.75,
                 width = 25)+
  geom_point(alpha = 0.5, size = 1, 
                 position = position_jitter(width = 1),  
             shape=19) +
    scale_fill_manual(values = site_colors) +
    #scale_color_viridis_c(option = "plasma") +
  labs(y = "CDOM",x="Burn area", color = "days since burn") +
  guides(shape = "none") +       # hides shape legend
  theme_minimal()

p4 <- df %>%
  ggplot(aes(x = burn_area,
             y = e2_e3)) +
    geom_boxplot(aes(fill=site), alpha = 0.75,
                 width = 25)+
  geom_point(alpha = 0.5, size = 1, 
                 position = position_jitter(width = 1),  
             shape=19, alpha=0.5) +
    scale_fill_manual(values = site_colors) +
    #scale_color_viridis_c(option = "plasma") +
  labs(y = "e2:e3",x="Burn area", color = "days since burn") +
  guides(shape = "none") +       # hides shape legend
  theme_minimal()

pannel <- ggarrange(
  p1a,
  p1b,
  #p1a1,
  p2,
  p4,
  p3,
  nrow=2, ncol=3,
  common.legend = T)

pannel
```




```{r, echo=FALSE, include =F}
# ggsave(plot = pannel, filename = paste("./Water_chem_optical_carbon_panel_v2.png",sep=""),width=6.5,height=5,dpi=300)

```


#### SUVA 254

Specific UV Absorbance at 254 nm (L mg⁻¹ m⁻¹), proxy for aromaticity (%
carbon in aromatic structures).

-   High (\>4): terrestrially derived, humic-rich DOM (e.g., forest
    soils, ? post-fire runoff)

-   Low (\<3): autochthonous (microbial/algal) DOM, more labile.

#### Sr

Sr (Slope ratio = S275–295 / S350–400)

-   High Sr (\>1.5): low molecular weight, microbially derived DOM
    (fresh, autochthonous)

-   Low Sr (\<1): high molecular weight, terrestrial/humic DOM (soils,
    vegetation leachates, fire-derived char)

#### CDOM

CDOM (Chromophoric DOM absorption)

Measures light-absorbing DOM at a reference wavelength (often 350 or 440
nm)

-    High CDOM = darker water, terrestrial DOM dominance

-   Low CDOM = clearer water, more algal or photobleached DOM

## Results

Looks like SUVA~254~ is highest for Ophir which is surprising, but all
SUVA~254~ values decline with days post fire. Similar Sr ratio pattern.

The CDOM patterns make more sense, where winters has higher signal
indicating the darkest water, while Ophir has a lower signal.

#### Total organic carbon flush?

```{r, echo=FALSE, fig.width=10, fig.height=6, fig.align='center', warning=F}
p <- df %>% 
  ggplot(aes(x = PPT_sum, 
             y = TOC.x, 
             color = days_since_burn)) +
  geom_point(alpha = 0.8, size =3) +  
  geom_smooth(method = "lm", se = FALSE, color = "grey30") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) +
  scale_color_viridis_c(option = "plasma") +
  labs(color = "Days since Sept 25, 2024",
       x = "PPT + Lag PPT",
       y = "TOC (mg/L)") + theme_minimal() +
  facet_wrap(~site, nrow = 2, scales = "free")
p

```

#### Dissolved organic carbon flush?

```{r, echo=FALSE, fig.width=10, fig.height=6, fig.align='center', warning=F}
p <- df %>% 
  ggplot(aes(x = PPT_sum, 
             y = DOC.x, 
             color = days_since_burn)) +
  geom_point(alpha = 0.8, size =3) +  
  geom_smooth(method = "lm", se = FALSE, color = "grey30") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) +
  scale_color_viridis_c(option = "plasma") +
  labs(color = "Days since Sept 25, 2024",
       x = "PPT + Lag PPT",
       y = "DOC (mg/L)") + theme_minimal() +
  facet_wrap(~site, nrow = 2, scales = "free")
p

```

#### Dissolved organic carbon flush?

```{r, echo=FALSE, fig.width=10, fig.height=6, fig.align='center', warning=F}
p <- df %>% 
  ggplot(aes(x = PPT_sum, 
             y = TDN, 
             color = days_since_burn)) +
  geom_point(alpha = 0.8, size =3) +  
  geom_smooth(method = "lm", se = FALSE, color = "grey30") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    size = 3
  ) +
  scale_color_viridis_c(option = "plasma") +
  labs(color = "Days since Sept 25, 2024",
       x = "PPT + Lag PPT",
       y = "TDN (mg/L)") + theme_minimal() +
  facet_wrap(~site, nrow = 2, scales = "free")
p

```

```{r, echo=FALSE, fig.width=10, fig.height=6, fig.align='center'}

# DOC–Q hysteresis plots
plot1<- ggplot(df, aes(x = dischargeCMS, y = DOC.x, color = datetime)) +
  geom_path(alpha = 0.7) +     # path instead of points to show loops
  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() + 
  scale_y_log10() +
  facet_wrap(~site, scales = "free") +
  scale_color_viridis_c(option = "plasma") +
  labs(x = "Discharge (CMS, log)",
       y = "DOC (mg/L, log)",
       color = "Date/Time",
       title = "DOC Concentration–Discharge Hysteresis by Site") +
  theme_minimal()

plot1
```





```{r, echo=FALSE, include =F}
# ggsave(plot = plot1, filename = paste("./DOC_hyst_panel.png",sep=""),width=8.75,height=5.75,dpi=300)

```



#### *Browns / Browns sub:*

-   Flow is being approximated from Ophir (similar creek size)

-   There are some short rising/falling trajectories, DOC doesn’t rise
    or fall consistently with Q.

#### *Davis:*

-   only two points connected, nearly vertical line

#### *Ophir:*

-   Shows the most zig-zagging trajectories.

-   Some segments hint at counter-clockwise patterns (DOC rising later
    relative to Q), so possible diluting relationship but overall the
    pattern is noisy.

#### *Winters* USGS

-   Some clockwise hysteresis (DOC higher during rising limb, then
    dropping as Q falls), indicating concentration with runoff

#### *Winters upstream*

Similar to Winters: a couple of loops could suggest clockwise patterns,
but not robust so likely some run-off concentration dynamics

## Sensitivity to precip.

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}
plot2<-ggplot(df, aes(x = dischargeCMS, y = DOC.x, color = PPT_sum), group = PPT_sum) +
  geom_path(alpha = 0.7) +
  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() + scale_y_log10() +
  facet_wrap(~site, scales = "free") +
  scale_color_viridis_c(option = "turbo") +
  labs(x = "Discharge (CMS, log)",
       y = "DOC (mg/L, log)",
       color = "Lagged and current PPT (mm)",
       title = "Event-scale DOC C–Q Hysteresis") +
  theme_minimal()

plot2
```



```{r, echo=FALSE, include =F}
# ggsave(plot = plot2, filename = paste("./DOC_hyst_panel_ppt.png",sep=""),width=8.75,height=5.75,dpi=300)

```


#### *Browns & Browns sub:*

-   Mostly clockwise spirals

-   DOC peaks early relative to Q, then drops as discharge declines,
    evidence of DOC sources being mobilized quickly

#### *Ophir*

-   Loops look counterclockwise (DOC remains higher or increases later
    in the event)

-   Suggesting delayed DOC contributions (perhaps hillslope or
    groundwater flow).

#### *Winters* USGS

-   Mixed hysteresis, but several loops lean clockwise (DOC elevated on
    rising limb)

-   Possible flushing of DOC. Road influence?

#### *Winters upstream*

-   More ambiguous, some counterclockwise hints, suggesting DOC delivery
    lagging behind peak discharge



### Double mass curves


```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}
# hydroclimate
# start date - 2024-10-01 


davis_hclim <- davis_hclim %>%
  filter(date >= as.Date("2024-10-01")) %>%
  mutate(sec_per_day = 86400) %>%
  arrange(Name, date) %>%
  group_by(Name) %>%
  mutate(
    ppt_c = cumsum(replace_na(ppt..mm., 0)),                 # cumulative ppt
    sec_c = (as.numeric(date - min(date) + 1)) * sec_per_day, # cumulative time (robust)
    Q_daily_liters = replace_na(dischargeCMS, 0) * 1000 * sec_per_day,
    Q_c_liters = cumsum(Q_daily_liters)                      # cumulative discharge volume in liters
  )



plot2<-ggplot(davis_hclim, aes(x = date, y = ppt_c)) +
  geom_point(size = 2, alpha = 0.7) +
  facet_wrap(~Name)  +
  theme_minimal()

plot2


plot2<-ggplot(davis_hclim, aes(x = date, y = Q_c_liters)) +
  geom_point(size = 2, alpha = 0.7) +
  facet_wrap(~Name, scales="free")  +
  theme_minimal()

plot2



```


```{r, warning=F, size = 'small', echo=FALSE, include=FALSE}

davis_dat <- davis_data %>%
  left_join(davis_hclim, by=c("creek"="Name", "date"))

davis_dat_c <- davis_dat%>%
  ### DL 
  mutate(As = if_else(As =="BDL",
                 As_DL,
                 as.numeric(As)),
         Al = if_else(Al =="BDL",
                 Al_DL,
                 as.numeric(Al)),
         Ca = if_else(Ca =="BDL",
                 Ca_DL,
                 as.numeric(Ca)),
         Fe = if_else(Fe =="BDL",
                 Fe_DL,
                 as.numeric(Fe)),
         Pb = if_else(Pb =="BDL",
                 Pb_DL,
                 as.numeric(Pb)),
         Mn = if_else(Mn =="BDL",
                 Mn_DL,
                 as.numeric(Mn))
         )%>%
  arrange(site, date) %>%
  group_by(site) %>%
  mutate(
    DOC_c = cumsum(replace_na(DOC, 0)), 
    TOC_c = cumsum(replace_na(TOC, 0)),
    TDN_c = cumsum(replace_na(TDN, 0)),
    As_c = cumsum(replace_na(As, 0)),
    Al_c = cumsum(replace_na(Al, 0)),
    Ca_c = cumsum(replace_na(Ca, 0)),
    Fe_c = cumsum(replace_na(Fe, 0)),
    Pb_c = cumsum(replace_na(Pb, 0)),
    Mn_c = cumsum(replace_na(Mn, 0)))

# arsenic, aluminum, cadmium, iron, manganese, mercury, and lead  


davis_dat_c <- davis_dat %>%
  mutate(
    As = if_else(As == "BDL", As_DL, as.numeric(As)),
    Al = if_else(Al == "BDL", Al_DL, as.numeric(Al)),
    Ca = if_else(Ca == "BDL", Ca_DL, as.numeric(Ca)),
    Fe = if_else(Fe == "BDL", Fe_DL, as.numeric(Fe)),
    Pb = if_else(Pb == "BDL", Pb_DL, as.numeric(Pb)),
    Mn = if_else(Mn == "BDL", Mn_DL, as.numeric(Mn))
  ) %>%
  arrange(site, date) %>%
  group_by(site) %>%
  mutate(across(
    .cols = c(DOC, TOC, TDN, As, Al, Ca, Fe, Pb, Mn),
    .fns  = ~ cumsum(replace_na(.x, 0)),
    .names = "{.col}_c"
  ))%>% 
  mutate(
    days_since_burn = as.integer(difftime(datetime, ref_date, units = "days")))


```

## Double mass and DOC

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize DOC df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    DOC_c_norm = DOC_c / max(DOC_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(DOC_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)


library(dplyr)
library(tidyr)
library(purrr)
library(broom)

models_doc <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(DOC_c_norm ~ 0 + Q_c_norm, data = .x)),  # or: ~ Q_c_norm - 1
    tidy  = map(model, ~ tidy(.x, conf.int = TRUE))
  ) %>%
  unnest(tidy) %>%
  filter(term == "Q_c_norm") %>%
  rename(slope = estimate, lwr = conf.low, upr = conf.high)


inference_doc <- models_doc %>%
  transmute(
    site, slope, lwr, upr, p.value,
    interpretation = case_when(
      slope > 1 & p.value < 0.05 ~ "solute ↑ faster than discharge (enrichment)",
      slope < 1 & p.value < 0.05 ~ "discharge ↑ faster than solute (dilution)",
      TRUE      ~ "proportional"
    )
  )
print(inference_doc)


library(ggplot2)
# 
# ggplot(davis_dat_norm, aes(x = Q_c_norm, y = DOC_c_norm)) +
#   geom_point(aes(color = days_since_burn), size = 2) +
#   geom_path() +
#   geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE, color = "grey25", linewidth = 1) +
#   geom_abline(slope = 1, intercept = 0, linetype = "dashed") +   # 1:1 reference
#   facet_wrap(~ site) +
#   coord_equal(xlim = c(0,1), ylim = c(0,1)) +
#   scale_color_viridis_c(option = "plasma", direction = -1) +
#   labs(
#     x = "Normalized cumulative discharge",
#     y = "Normalized cumulative DOC",
#     title = "Double mass curves of Mn vs discharge (0-intercept fits)"
#   ) +
#   theme_bw()

DMC_DOC_plot<- ggplot(davis_dat_norm, aes(Q_c_norm, DOC_c_norm)) +
  geom_point(aes(color = days_since_burn), size = 2) +
  geom_path() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_abline(
    data = models_doc, aes(slope = slope, intercept = 0),
    inherit.aes = FALSE, color = "grey25", linewidth = 1
  ) +
  facet_wrap(~ site) +
  coord_equal(xlim = c(0,1), ylim = c(0,1)) +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  labs(
    color = "Days since fire",
    x = "Normalized cumulative discharge (L)",
    y = "Normalized cumulative DOC (mgL)"
  ) +
  theme_minimal()


# ggplot(davis_dat_norm, aes(x = Q_c_norm, y = DOC_c_norm)) +
#   geom_point(aes(color=days_since_burn),size=2) +
#   geom_line() +
#     geom_smooth(method = "lm", se = FALSE, color = "grey25", size = 1) +
#     facet_wrap(~site, scales = "free") +
#     scale_color_viridis_c(option = "plasma", direction = -1) +
#   facet_wrap(~site, scales = "free") +
#   labs(
#     x = "Normalized cumulative discharge",
#     y = "Normalized cumulative DOC",
#     title = "Double mass curves of DOC vs discharge"
#   ) +
#   theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(DOC_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = DOC_c_norm - fit
                   ))
  ) %>%
  unnest(data)



DMCres_DOC_plot<- ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site) +
  labs(
    x = "Date",
    y = "Residuals (DOC – fitted)",
    title = "Residual mass curves (DOC vs discharge)"
  ) +
  theme_bw()


```


```{r, echo=FALSE, include =F}
# ggsave(plot = DMC_DOC_plot, filename = paste("./DMC_DOC_plot.png",sep=""),width=8.75,height=5.75,dpi=300)

```



```{r, echo=FALSE, include =F}
# ggsave(plot = DMCres_DOC_plot, filename = paste("./DMC_res_DOC_plot.png",sep=""),width=8.75,height=3.75,dpi=300)

```


## Double mass and TDN





```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize DOC df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    TDN_c_norm = TDN_c / max(TDN_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(TDN_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)


library(dplyr)
library(tidyr)
library(purrr)
library(broom)

models_tdn <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(TDN_c_norm ~ 0 + Q_c_norm, data = .x)),  # or: ~ Q_c_norm - 1
    tidy  = map(model, ~ tidy(.x, conf.int = TRUE))
  ) %>%
  unnest(tidy) %>%
  filter(term == "Q_c_norm") %>%
  rename(slope = estimate, lwr = conf.low, upr = conf.high)


inference_tdn <- models_tdn %>%
  transmute(
    site, slope, lwr, upr,
    interpretation = case_when(
      slope > 1 ~ "solute ↑ faster than discharge (enrichment)",
      slope < 1 ~ "discharge ↑ faster than solute (dilution)",
      TRUE      ~ "proportional"
    )
  )
print(inference_mn)


library(ggplot2)
# 
# ggplot(davis_dat_norm, aes(x = Q_c_norm, y = TDN_c_norm)) +
#   geom_point(aes(color = days_since_burn), size = 2) +
#   geom_path() +
#   geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE, color = "grey25", linewidth = 1) +
#   geom_abline(slope = 1, intercept = 0, linetype = "dashed") +   # 1:1 reference
#   facet_wrap(~ site) +
#   coord_equal(xlim = c(0,1), ylim = c(0,1)) +
#   scale_color_viridis_c(option = "plasma", direction = -1) +
#   labs(
#     x = "Normalized cumulative discharge",
#     y = "Normalized cumulative DOC",
#     title = "Double mass curves of Mn vs discharge (0-intercept fits)"
#   ) +
#   theme_bw()

DMC_TDN_plot<- ggplot(davis_dat_norm, aes(Q_c_norm, TDN_c_norm)) +
  geom_point(aes(color = days_since_burn), size = 2) +
  geom_path() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_abline(
    data = models_tdn, aes(slope = slope, intercept = 0),
    inherit.aes = FALSE, color = "grey25", linewidth = 1
  ) +
  facet_wrap(~ site) +
  coord_equal(xlim = c(0,1), ylim = c(0,1)) +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  labs(
    color = "Days since fire",
    x = "Normalized cumulative discharge (L)",
    y = "Normalized cumulative TDN (mgL)"
  ) +
  theme_minimal()


# ggplot(davis_dat_norm, aes(x = Q_c_norm, y = TDN_c_norm)) +
#   geom_point(aes(color=days_since_burn),size=2) +
#   geom_line() +
#     geom_smooth(method = "lm", se = FALSE, color = "grey25", size = 1) +
#     facet_wrap(~site, scales = "free") +
#     scale_color_viridis_c(option = "plasma", direction = -1) +
#   facet_wrap(~site, scales = "free") +
#   labs(
#     x = "Normalized cumulative discharge",
#     y = "Normalized cumulative DOC",
#     title = "Double mass curves of DOC vs discharge"
#   ) +
#   theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(TDN_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = TDN_c_norm - fit
                   ))
  ) %>%
  unnest(data)



DMCres_TDN_plot<- ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site) +
  labs(
    x = "Date",
    y = "Residuals (TDN – fitted)",
    title = "Residual mass curves (TDN vs discharge)"
  ) +
  theme_bw()


```


```{r, echo=FALSE, include =F}
# ggsave(plot = DMC_TDN_plot, filename = paste("./DMC_TDN_plot.png",sep=""),width=8.75,height=5.75,dpi=300)

```



```{r, echo=FALSE, include =F}
# ggsave(plot = DMCres_TDN_plot, filename = paste("./DMC_res_TDN_plot.png",sep=""),width=8.75,height=3.75,dpi=300)

```
















PAUSE

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize DOC df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    DOC_c_norm = DOC_c / max(DOC_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(DOC_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = DOC_c_norm)) +
  geom_point() +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  facet_wrap(~site, scales = "free") +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative DOC",
    title = "Double mass curves of DOC vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(DOC_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = DOC_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (DOC – fitted)",
    title = "Residual mass curves (DOC vs discharge)"
  ) +
  theme_bw()


```

## Double mass and nitrogen 

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize Al df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    Al_c_norm = Al_c / max(Al_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Al_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = Al_c_norm)) +
  geom_point() +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  facet_wrap(~site, scales = "free") +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative Al",
    title = "Double mass curves of Al vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Al_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = Al_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (Al – fitted)",
    title = "Residual mass curves (Al vs discharge)"
  ) +
  theme_bw()


```



## Double mass and nitrogen 

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize Al df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    As_c_norm = As_c / max(As_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(As_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = As_c_norm)) +
  geom_point() +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  facet_wrap(~site, scales = "free") +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative Al",
    title = "Double mass curves of As vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(As_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = As_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (As – fitted)",
    title = "Residual mass curves (Al vs discharge)"
  ) +
  theme_bw()


```




## Double mass and nitrogen 

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize Al df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    Fe_c_norm = Fe_c / max(Fe_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Fe_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = Fe_c_norm)) +
  geom_point() +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  facet_wrap(~site, scales = "free") +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative Al",
    title = "Double mass curves of As vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Fe_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = Fe_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (As – fitted)",
    title = "Residual mass curves (Al vs discharge)"
  ) +
  theme_bw()


```




## Double mass and nitrogen 

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize Al df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    Pb_c_norm = Pb_c / max(Pb_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Pb_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = Pb_c_norm)) +
  geom_point() +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  facet_wrap(~site, scales = "free") +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative Al",
    title = "Double mass curves of As vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Pb_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = Pb_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (As – fitted)",
    title = "Residual mass curves (Al vs discharge)"
  ) +
  theme_bw()


```





## Double mass and nitrogen 

```{r, warning=F, size = 'small', echo=FALSE, fig.width=10, fig.height=6}


### Normalize Al df:
davis_dat_norm <- davis_dat_c %>%
  group_by(site) %>%
  mutate(
    Mn_c_norm = Mn_c / max(Mn_c, na.rm = TRUE),   # 0–1 scaling
    Q_c_norm   = Q_c_liters / max(Q_c_liters, na.rm = TRUE)
  )


library(tidyr)
library(broom)

## models 

models <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Mn_c_norm ~ Q_c_norm, data = .x)),
    tidy_model = map(model, tidy)
  ) %>%
  unnest(tidy_model)

ggplot(davis_dat_norm, aes(x = Q_c_norm, y = Mn_c_norm)) +
  geom_point(aes(color = days_since_burn), size=2) +
  geom_line() +
    geom_smooth(method = "lm", se = FALSE, color = "grey25", size = 1) +
  facet_wrap(~site, scales = "free") +
    scale_color_viridis_c(option = "plasma", direction = -1) +
  labs(
    x = "Normalized cumulative discharge",
    y = "Normalized cumulative Mn",
    title = "Double mass curves of As vs discharge"
  ) +
  theme_bw()


## residuals 
davis_dat_resid <- davis_dat_norm %>%
  group_by(site) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(Mn_c_norm ~ Q_c_norm, data = .x)),
    data  = map2(data, model, ~ .x %>%
                   mutate(
                     fit   = predict(.y, newdata = .x),
                     resid = Mn_c_norm - fit
                   ))
  ) %>%
  unnest(data)



ggplot(davis_dat_resid, aes(x = date, y = resid)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~site, scales = "free_x") +
  labs(
    x = "Date",
    y = "Residuals (As – fitted)",
    title = "Residual mass curves (Al vs discharge)"
  ) +
  theme_bw()


```

End script.

